<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:TorusTool.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="TorusTool.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Name="MainWindowRoot"
        Icon="/Assets/avalonia-logo.ico"
        Title="TorusTool">

    <Design.DataContext>
        <!-- This only sets the DataContext for the previewer in an IDE,
             to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto, Auto, *">
        <!-- New Menu Bar -->
        <Menu Grid.Row="0">
            <MenuItem Header="_File">
                <MenuItem Header="_Open..." Command="{Binding OpenFileCommand}" CommandParameter="{Binding $parent[Window].StorageProvider}"/>
                <MenuItem Header="_Recent Files" ItemsSource="{Binding RecentFiles}">
                    <MenuItem.ItemTemplate>
                        <DataTemplate>
                            <MenuItem Header="{Binding}" Command="{Binding #MainWindowRoot.((vm:MainWindowViewModel)DataContext).LoadRecentFileCommand}" CommandParameter="{Binding}"/>
                        </DataTemplate>
                    </MenuItem.ItemTemplate>
                </MenuItem>
                <Separator/>
                <MenuItem Header="E_xit" Command="{Binding ExitAppCommand}"/>
            </MenuItem>
            <!-- New Tools Menu -->
             <MenuItem Header="_Tools">
                 <MenuItem Header="Font Tool..." Command="{Binding OpenFontToolCommand}"/>
                 <Separator/>
                 <MenuItem Header="Ex_port HNK..." Command="{Binding ExportHnkCommand}" CommandParameter="{Binding $parent[Window].StorageProvider}"/>
                 <MenuItem Header="Im_port HNK..." Command="{Binding ImportHnkCommand}" CommandParameter="{Binding $parent[Window].StorageProvider}"/>
                 <Separator/>
                 <MenuItem Header="3DS Tools..." Command="{Binding OpenTools3DSCommand}" CommandParameter="{Binding $parent[Window]}"/>
             </MenuItem>
        </Menu>
        
        <StackPanel Grid.Row="1" Orientation="Vertical" Margin="10">
            <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Text="Game Format:" VerticalAlignment="Center"/>
                <ComboBox ItemsSource="{Binding AvailableGames}" SelectedItem="{Binding SelectedGame}" MinWidth="200">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Name}"/>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
            </StackPanel>
            <TextBlock Text="{Binding CurrentFile}" VerticalAlignment="Center" Margin="0,5,0,0"/>
        </StackPanel>

        <Grid Grid.Row="2" ColumnDefinitions="300, 5, *" Margin="10">
            <!-- Tree View -->
            <Grid Grid.Column="0" RowDefinitions="*, Auto">
                <TreeView Grid.Row="0" ItemsSource="{Binding RootNodes}" SelectedItem="{Binding SelectedNode}">
                    <TreeView.ItemTemplate>
                        <TreeDataTemplate ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal" Spacing="5">
                                 <TextBlock Text="{Binding Icon}"/>
                                 <TextBlock Text="{Binding Name}"/>
                            </StackPanel>
                        </TreeDataTemplate>
                    </TreeView.ItemTemplate>
                </TreeView>
                <!-- Toggle View Mode Button -->
                <CheckBox Grid.Row="1" Content="Show Hex Only" IsChecked="{Binding ShowHexOnly}" Margin="5">
                    <CheckBox.IsEnabled>
                        <MultiBinding Converter="{x:Static BoolConverters.Or}">
                            <Binding Path="HasStringTable"/>
                            <Binding Path="HasHunkHeader"/>
                            <Binding Path="HasFontDescriptor"/>
                        </MultiBinding>
                    </CheckBox.IsEnabled>
                </CheckBox>
            </Grid>
            
            <GridSplitter Grid.Column="1" ResizeDirection="Columns" Background="Gray"/>
            
            <!-- Right Panel -->
            <Grid Grid.Column="2" RowDefinitions="Auto, Auto, *, Auto">
                <!-- DataGrid View (String Table) -->
                <DataGrid Grid.Row="0" ItemsSource="{Binding CurrentStringTable}" IsVisible="{Binding IsStringTableVisible}"
                          AutoGenerateColumns="True" IsReadOnly="True" GridLinesVisibility="All"
                          BorderThickness="1" BorderBrush="Gray" Height="200">
                </DataGrid>

                <!-- DataGrid View (Hunk Header) -->
                <DataGrid Grid.Row="1" ItemsSource="{Binding CurrentHunkHeader}" IsVisible="{Binding IsHunkHeaderVisible}"
                          AutoGenerateColumns="True" IsReadOnly="True" GridLinesVisibility="All"
                          BorderThickness="1" BorderBrush="Gray" Height="150">
                </DataGrid>

                <!-- Main Content Area (Shared Row 2) -->
                
                <!-- DataGrid View (Font Descriptor) -->
                <Grid Grid.Row="2" RowDefinitions="Auto, *, *" IsVisible="{Binding IsFontDescriptorVisible}">
                    <!-- Header Info -->
                    <StackPanel Grid.Row="0" Orientation="Vertical" Margin="5" Background="#303030">
                        <TextBlock Text="Platform Header (0x00)" FontWeight="Bold" Margin="5"/>
                        <WrapPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding SelectedFontDescriptor.PlatformHeader.VersionOrFlags, StringFormat='Ver: {0}'}" Margin="5"/>
                            <TextBlock Text="{Binding SelectedFontDescriptor.PlatformHeader.LineHeight, StringFormat='LineHeight: {0}'}" Margin="5"/>
                            <TextBlock Text="{Binding SelectedFontDescriptor.PlatformHeader.BBoxMinX, StringFormat='MinX: {0}'}" Margin="5"/>
                            <TextBlock Text="{Binding SelectedFontDescriptor.PlatformHeader.BBoxMinY, StringFormat='MinY: {0}'}" Margin="5"/>
                            <TextBlock Text="{Binding SelectedFontDescriptor.PlatformHeader.GlyphCount, StringFormat='Glyphs: {0}'}" Margin="5"/>
                            <TextBlock Text="{Binding SelectedFontDescriptor.PlatformHeader.GlyphDataCount, StringFormat='GlyphData: {0}'}" Margin="5"/>
                        </WrapPanel>
                        <TextBlock Text="File Header LE (0x10)" FontWeight="Bold" Margin="5"/>
                        <WrapPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding SelectedFontDescriptor.FileHeader.TableCount, StringFormat='Tables: {0}'}" Margin="5"/>
                            <TextBlock Text="{Binding SelectedFontDescriptor.FileHeader.PreGlyphOffset, StringFormat='PreOff: {0:X}'}" Margin="5"/>
                            <TextBlock Text="{Binding SelectedFontDescriptor.FileHeader.GlyphTableOffset, StringFormat='GlyphOff: {0:X}'}" Margin="5"/>
                            <TextBlock Text="{Binding SelectedFontDescriptor.FileHeader.UnicodeOffset, StringFormat='UniOff: {0:X}'}" Margin="5"/>
                        </WrapPanel>
                    </StackPanel>

                    <!-- DataGrid View (Font Descriptor) -->
                    <DataGrid Grid.Row="1" ItemsSource="{Binding CurrentFontItems}"
                              AutoGenerateColumns="False" IsReadOnly="True" GridLinesVisibility="All"
                              BorderThickness="1" BorderBrush="Gray">
                        <DataGrid.Columns>
                           <DataGridTextColumn Header="Idx" Binding="{Binding Index}"/>
                           <DataGridTextColumn Header="Char" Binding="{Binding CharDisplay}"/>
                           <DataGridTextColumn Header="Raw Hex (V0-V3)" Binding="{Binding RowData}"/>
                           <DataGridTextColumn Header="X" Binding="{Binding X}"/>
                           <DataGridTextColumn Header="Y" Binding="{Binding Y}"/>
                           <DataGridTextColumn Header="W" Binding="{Binding Width}"/>
                           <DataGridTextColumn Header="H" Binding="{Binding Height}"/>
                           <DataGridTextColumn Header="Aux" Binding="{Binding Aux}"/>
                           <DataGridTextColumn Header="Extra (A,B,C,D)" Binding="{Binding ExtraData}"/>
                        </DataGrid.Columns>
                    </DataGrid>
    
                    <!-- Atlas View (Font Descriptor) -->
                     <ScrollViewer Grid.Row="2" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                         <ItemsControl ItemsSource="{Binding CurrentFontItems}">
                             <ItemsControl.ItemsPanel>
                                 <ItemsPanelTemplate>
                                     <Canvas Width="1024" Height="1024" Background="Black"/>
                                 </ItemsPanelTemplate>
                             </ItemsControl.ItemsPanel>
                             <ItemsControl.ItemTemplate>
                                 <DataTemplate>
                                     <Rectangle Width="{Binding Width}" Height="{Binding Height}"
                                                Stroke="Lime" StrokeThickness="1"
                                                Fill="#3300FF00" 
                                                Canvas.Left="{Binding X}" Canvas.Top="{Binding Y}"
                                                IsVisible="{Binding IsVisibleInAtlas}">
                                         <ToolTip.Tip>
                                             <StackPanel>
                                                <TextBlock Text="{Binding CharDisplay}"/>
                                                <TextBlock Text="{Binding DecodedData}"/>
                                             </StackPanel>
                                         </ToolTip.Tip>
                                     </Rectangle>
                                 </DataTemplate>
                             </ItemsControl.ItemTemplate>
                         </ItemsControl>
                    </ScrollViewer>
                </Grid>

                <!-- DataGrid View (DataTable Strings/Hex) -->
                <DataGrid Grid.Row="2" ItemsSource="{Binding CurrentDataTableItems}" IsVisible="{Binding IsDataTableVisible}"
                          AutoGenerateColumns="False" IsReadOnly="True" GridLinesVisibility="All"
                          BorderThickness="1" BorderBrush="Gray">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Index" Binding="{Binding Index}"/>
                        <DataGridTextColumn Header="Hex" Binding="{Binding HexValue}" FontFamily="Consolas, Monospace"/>
                        <DataGridTextColumn Header="Extracted String" Binding="{Binding StringValue}"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- DataGrid View (RenderSprite) -->
                <Grid Grid.Row="2" ColumnDefinitions="*, *" IsVisible="{Binding IsRenderSpriteVisible}">
                    <DataGrid Grid.Column="0" ItemsSource="{Binding CurrentRenderSpriteItems}" 
                              SelectedItem="{Binding SelectedRenderSpriteItem}"
                              AutoGenerateColumns="False" IsReadOnly="True" GridLinesVisibility="All"
                              BorderThickness="1" BorderBrush="Gray">
                        <DataGrid.Columns>
                              <DataGridTextColumn Header="Idx" Binding="{Binding Index}" MinWidth="40"/>
                              <DataGridTextColumn Header="Spd/Thk" Binding="{Binding Block.SpeedOrThickness, StringFormat='0.00'}" MinWidth="60"/>
                              <DataGridTextColumn Header="W" Binding="{Binding Block.Width, StringFormat='0.0'}" MinWidth="50" Width="100"/>
                              <DataGridTextColumn Header="H" Binding="{Binding Block.Height, StringFormat='0.0'}" MinWidth="50" Width="100"/>
                              <DataGridTextColumn Header="UV Left" Binding="{Binding Block.UvLeft, StringFormat='0.00'}" MinWidth="60" Width="100"/>
                              <DataGridTextColumn Header="UV Top" Binding="{Binding Block.UvTop, StringFormat='0.00'}" MinWidth="60" Width="100"/>
                              <DataGridTextColumn Header="Idx/Ang" Binding="{Binding Block.IndexOrAngle, StringFormat='0.0'}" MinWidth="60"/>
                              <DataGridTextColumn Header="RingTp" Binding="{Binding Block.RingType}" MinWidth="40"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <!-- Sprite Visualizer -->
                    <Border Grid.Column="1" BorderBrush="Gray" BorderThickness="1" Background="#202020" Margin="5">
                        <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                             <Grid>
                                 <Image Source="{Binding CurrentRenderSpriteTexture}" Stretch="None"/>
                                 <Canvas Width="{Binding CurrentRenderSpriteTexture.Size.Width}" Height="{Binding CurrentRenderSpriteTexture.Size.Height}" IsHitTestVisible="False">
                                     <Rectangle Canvas.Left="{Binding SelectedSpriteRect.X}"
                                                Canvas.Top="{Binding SelectedSpriteRect.Y}"
                                                Width="{Binding SelectedSpriteRect.Width}"
                                                Height="{Binding SelectedSpriteRect.Height}"
                                                Stroke="Cyan" StrokeThickness="2" Fill="#4000FFFF"/>
                                 </Canvas>
                             </Grid>
                        </ScrollViewer>
                    </Border>
                </Grid>

                <!-- Texture View -->
                <Grid Grid.Row="2" IsVisible="{Binding IsTextureVisible}">
                     <Grid.RowDefinitions>
                         <RowDefinition Height="Auto"/>
                         <RowDefinition Height="*"/>
                     </Grid.RowDefinitions>
                     <StackPanel Orientation="Horizontal" Spacing="10">
                         <TextBox Text="{Binding TextureInfo}" FontWeight="Bold" Margin="5" IsReadOnly="True" Width="800" TextWrapping="Wrap"/>
                         <CheckBox Content="Big Endian" IsChecked="{Binding IsBigEndian}" Margin="5"/>
                     </StackPanel>
                     
                     <Border Grid.Row="1" BorderBrush="Gray" BorderThickness="1" Background="#202020" Margin="5">
                         <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                             <Image Source="{Binding CurrentTextureImage}" Stretch="None"/>
                         </ScrollViewer>
                     </Border>
                </Grid>

                <!-- Hex View -->
                <ScrollViewer Grid.Row="3">
                    <ScrollViewer.IsVisible>
                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                            <Binding Path="!IsStringTableVisible"/>
                            <Binding Path="!IsHunkHeaderVisible"/>
                            <Binding Path="!IsFontDescriptorVisible"/>
                            <Binding Path="!IsRenderSpriteVisible"/>
                            <Binding Path="!IsTextureVisible"/>
                            <Binding Path="!IsDataTableVisible"/>
                        </MultiBinding>
                    </ScrollViewer.IsVisible>
                    <TextBlock Text="{Binding HexViewText}" FontFamily="Consolas, Monospace" FontSize="12" Margin="5"/>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Grid>
</Window>
